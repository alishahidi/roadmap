<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-guides docs-version-current docs-doc-page docs-doc-id-ddd-csharp" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.8.1">
<title data-rh="true">Domain-Driven Design (DDD) in C# | The Software Architect&#x27;s Roadmap</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://alishahidi.github.io/roadmap/img/roadmap-logo.png"><meta data-rh="true" name="twitter:image" content="https://alishahidi.github.io/roadmap/img/roadmap-logo.png"><meta data-rh="true" property="og:url" content="https://alishahidi.github.io/roadmap/guides/ddd-csharp"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-guides-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-guides-current"><meta data-rh="true" property="og:title" content="Domain-Driven Design (DDD) in C# | The Software Architect&#x27;s Roadmap"><meta data-rh="true" name="description" content="A practical, end-to-end guide to applying DDD in C# with examples, diagrams, and references."><meta data-rh="true" property="og:description" content="A practical, end-to-end guide to applying DDD in C# with examples, diagrams, and references."><link data-rh="true" rel="icon" href="/roadmap/img/roadmap-logo.png"><link data-rh="true" rel="canonical" href="https://alishahidi.github.io/roadmap/guides/ddd-csharp"><link data-rh="true" rel="alternate" href="https://alishahidi.github.io/roadmap/guides/ddd-csharp" hreflang="en"><link data-rh="true" rel="alternate" href="https://alishahidi.github.io/roadmap/guides/ddd-csharp" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Domain-Driven Design (DDD) in C#","item":"https://alishahidi.github.io/roadmap/guides/ddd-csharp"}]}</script><link rel="stylesheet" href="/roadmap/assets/css/styles.1f80ee82.css">
<script src="/roadmap/assets/js/runtime~main.f6408f3a.js" defer="defer"></script>
<script src="/roadmap/assets/js/main.4e51b58c.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t="light";var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",e||t),document.documentElement.setAttribute("data-theme-choice",e||t)}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/roadmap/img/roadmap-logo.png"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/roadmap/"><div class="navbar__logo"><img src="/roadmap/img/roadmap-logo.png" alt="Roadmap Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/roadmap/img/roadmap-logo.png" alt="Roadmap Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">The Architect&#x27;s Roadmap</b></a><a class="navbar__item navbar__link" href="/roadmap/docs/foundations">The Roadmap</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/roadmap/guides/ddd-csharp">Guides</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a href="https://github.com/alishahidi/roadmap" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--active">Guides</a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/roadmap/guides/ddd-csharp">Domain-Driven Design (DDD) in C#</a></li></ul></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/roadmap/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Guides</span></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">Domain-Driven Design (DDD) in C#</span></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Domain-Driven Design (DDD) in C#</h1></header><blockquote>
<p>A concise, practical guide to DDD with C# examples. Large code listings are collapsed by default for easy reading.</p>
</blockquote>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="what-you-will-learn">What you will learn<a href="#what-you-will-learn" class="hash-link" aria-label="Direct link to What you will learn" title="Direct link to What you will learn">​</a></h3>
<ul>
<li>Understand DDD essentials: ubiquitous language, bounded contexts, aggregates, and domain events.</li>
<li>Design an order domain in C# with entities, value objects, repositories, and application services.</li>
<li>Apply a layered architecture and optional CQRS.</li>
<li>Visualize flows with Mermaid diagrams.</li>
</ul>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>This guide focuses on pragmatic DDD for typical service-backed systems. It balances rigor with practicality.</p></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="core-concepts">Core concepts<a href="#core-concepts" class="hash-link" aria-label="Direct link to Core concepts" title="Direct link to Core concepts">​</a></h2>
<ul>
<li><strong>Ubiquitous Language</strong>: Shared terms between domain experts and developers.</li>
<li><strong>Bounded Context</strong>: A semantic boundary around a model. Integrations occur at the boundaries.</li>
<li><strong>Entity</strong>: Has identity and lifecycle. Example: <code>Order</code>.</li>
<li><strong>Value Object</strong>: Immutable, equality by value. Example: <code>Money</code>, <code>Address</code>.</li>
<li><strong>Aggregate</strong>: A cluster of entities/value objects with a single root (e.g., <code>Order</code> as root). Invariants are enforced inside the aggregate.</li>
<li><strong>Domain Event</strong>: Something that happened in the domain (e.g., <code>OrderPlaced</code>).</li>
<li><strong>Repository</strong>: Collection-like interface to persist aggregates.</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="big-picture">Big picture<a href="#big-picture" class="hash-link" aria-label="Direct link to Big picture" title="Direct link to Big picture">​</a></h2>
<!-- -->
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="context-mapping">Context mapping<a href="#context-mapping" class="hash-link" aria-label="Direct link to Context mapping" title="Direct link to Context mapping">​</a></h2>
<!-- -->
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="example-domain-orders">Example domain: Orders<a href="#example-domain-orders" class="hash-link" aria-label="Direct link to Example domain: Orders" title="Direct link to Example domain: Orders">​</a></h2>
<p>We will model a minimal Order domain:</p>
<ul>
<li><strong>Aggregate Root</strong>: <code>Order</code></li>
<li><strong>Child Entity</strong>: <code>OrderItem</code></li>
<li><strong>Value Objects</strong>: <code>Money</code>, <code>ProductId</code>, <code>OrderId</code></li>
<li><strong>Domain Events</strong>: <code>OrderPlaced</code></li>
<li><strong>Repository</strong>: <code>IOrderRepository</code></li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="value-objects">Value objects<a href="#value-objects" class="hash-link" aria-label="Direct link to Value objects" title="Direct link to Value objects">​</a></h3>
<details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary>Base ValueObject and Money</summary><div><div class="collapsibleContent_i85q"><div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">using System.Collections.Generic;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">using System.Linq;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public abstract class ValueObject</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected abstract IEnumerable&lt;object?&gt; GetEqualityComponents();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public override bool Equals(object? obj)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (obj is null || obj.GetType() != GetType()) return false;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        var other = (ValueObject)obj;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return GetEqualityComponents().SequenceEqual(other.GetEqualityComponents());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public override int GetHashCode()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return GetEqualityComponents()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .Aggregate(0, (hash, component) =&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                HashCode.Combine(hash, component?.GetHashCode() ?? 0));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public sealed class Money : ValueObject</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public decimal Amount { get; }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public string Currency { get; }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private Money(decimal amount, string currency)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (amount &lt; 0) throw new ArgumentOutOfRangeException(nameof(amount));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (string.IsNullOrWhiteSpace(currency)) throw new ArgumentException(&quot;Currency required&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Amount = decimal.Round(amount, 2);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Currency = currency.ToUpperInvariant();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static Money Of(decimal amount, string currency) =&gt; new(amount, currency);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected override IEnumerable&lt;object?&gt; GetEqualityComponents()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        yield return Amount;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        yield return Currency;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static Money operator +(Money a, Money b)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (a.Currency != b.Currency) throw new InvalidOperationException(&quot;Currency mismatch&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return Of(a.Amount + b.Amount, a.Currency);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div></div></div></details>
<details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary>Identifiers as Value Objects</summary><div><div class="collapsibleContent_i85q"><div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public sealed class OrderId : ValueObject</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Guid Value { get; }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private OrderId(Guid value) =&gt; Value = value;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static OrderId New() =&gt; new(Guid.NewGuid());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static OrderId From(Guid value) =&gt; new(value);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected override IEnumerable&lt;object?&gt; GetEqualityComponents() { yield return Value; }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public override string ToString() =&gt; Value.ToString();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public sealed class ProductId : ValueObject</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Guid Value { get; }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private ProductId(Guid value) =&gt; Value = value;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static ProductId From(Guid value) =&gt; new(value);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected override IEnumerable&lt;object?&gt; GetEqualityComponents() { yield return Value; }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public override string ToString() =&gt; Value.ToString();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div></div></div></details>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="aggregate">Aggregate<a href="#aggregate" class="hash-link" aria-label="Direct link to Aggregate" title="Direct link to Aggregate">​</a></h3>
<details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary>Order aggregate with invariants and events</summary><div><div class="collapsibleContent_i85q"><div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public sealed class Order</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private readonly List&lt;OrderItem&gt; _items = new();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private readonly List&lt;object&gt; _domainEvents = new();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public OrderId Id { get; }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public string CustomerEmail { get; private set; }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public IReadOnlyCollection&lt;OrderItem&gt; Items =&gt; _items.AsReadOnly();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Money Total =&gt; _items.Aggregate(Money.Of(0, Currency), (acc, i) =&gt; acc + (i.UnitPrice * i.Quantity));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public string Currency { get; }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private Order(OrderId id, string customerEmail, string currency)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Id = id;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        CustomerEmail = customerEmail;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Currency = currency;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static Order CreateDraft(string customerEmail, string currency)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (string.IsNullOrWhiteSpace(customerEmail)) throw new ArgumentException(&quot;Email required&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new Order(OrderId.New(), customerEmail, currency);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void AddItem(ProductId productId, int quantity, Money unitPrice)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (quantity &lt;= 0) throw new ArgumentOutOfRangeException(nameof(quantity));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (unitPrice.Currency != Currency) throw new InvalidOperationException(&quot;Currency mismatch&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        var existing = _items.FirstOrDefault(i =&gt; i.ProductId.Equals(productId));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (existing is not null)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            existing.IncreaseQuantity(quantity);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        else</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            _items.Add(new OrderItem(productId, quantity, unitPrice));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void Place()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!_items.Any()) throw new InvalidOperationException(&quot;Cannot place empty order&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        _domainEvents.Add(new OrderPlaced(Id, Total));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public IReadOnlyCollection&lt;object&gt; DequeueDomainEvents()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        var copy = _domainEvents.ToArray();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        _domainEvents.Clear();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return copy;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public sealed class OrderItem</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ProductId ProductId { get; }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public int Quantity { get; private set; }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Money UnitPrice { get; }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public OrderItem(ProductId productId, int quantity, Money unitPrice)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (quantity &lt;= 0) throw new ArgumentOutOfRangeException(nameof(quantity));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ProductId = productId;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Quantity = quantity;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        UnitPrice = unitPrice;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void IncreaseQuantity(int by)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (by &lt;= 0) throw new ArgumentOutOfRangeException(nameof(by));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Quantity += by;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public sealed record OrderPlaced(OrderId OrderId, Money Total);</span><br></span></code></pre></div></div></div></div></details>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="repository-interface">Repository interface<a href="#repository-interface" class="hash-link" aria-label="Direct link to Repository interface" title="Direct link to Repository interface">​</a></h3>
<div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public interface IOrderRepository</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Task&lt;Order?&gt; GetAsync(OrderId id, CancellationToken ct = default);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Task AddAsync(Order order, CancellationToken ct = default);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Task SaveChangesAsync(CancellationToken ct = default);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="ef-core-mapping-infrastructure">EF Core mapping (infrastructure)<a href="#ef-core-mapping-infrastructure" class="hash-link" aria-label="Direct link to EF Core mapping (infrastructure)" title="Direct link to EF Core mapping (infrastructure)">​</a></h3>
<details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary>DbContext and ValueConverters</summary><div><div class="collapsibleContent_i85q"><div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">using Microsoft.EntityFrameworkCore;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">using Microsoft.EntityFrameworkCore.Storage.ValueConversion;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public sealed class OrdersDbContext : DbContext</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public DbSet&lt;Order&gt; Orders =&gt; Set&lt;Order&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected override void OnModelCreating(ModelBuilder modelBuilder)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        var orderIdConv = new ValueConverter&lt;OrderId, Guid&gt;(v =&gt; v.Value, v =&gt; OrderId.From(v));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        var productIdConv = new ValueConverter&lt;ProductId, Guid&gt;(v =&gt; v.Value, v =&gt; ProductId.From(v));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        modelBuilder.Entity&lt;Order&gt;(b =&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            b.HasKey(x =&gt; x.Id);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            b.Property(x =&gt; x.Id).HasConversion(orderIdConv);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            b.Property(x =&gt; x.CustomerEmail).IsRequired();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            b.Property(x =&gt; x.Currency).IsRequired();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            b.OwnsMany&lt;OrderItem&gt;(&quot;_items&quot;, nb =&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                nb.WithOwner().HasForeignKey(&quot;OrderId&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                nb.Property&lt;Guid&gt;(&quot;Id&quot;).ValueGeneratedOnAdd();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                nb.HasKey(&quot;Id&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                nb.Property(i =&gt; i.ProductId).HasConversion(productIdConv);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                nb.OwnsOne(i =&gt; i.UnitPrice, mb =&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    mb.Property(p =&gt; p.Amount).HasColumnName(&quot;UnitPriceAmount&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    mb.Property(p =&gt; p.Currency).HasColumnName(&quot;UnitPriceCurrency&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div></div></div></details>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="application-service-command-handler">Application service (command handler)<a href="#application-service-command-handler" class="hash-link" aria-label="Direct link to Application service (command handler)" title="Direct link to Application service (command handler)">​</a></h3>
<div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public sealed record PlaceOrderCommand(string CustomerEmail, string Currency, IReadOnlyCollection&lt;(Guid ProductId, int Quantity, decimal UnitPrice)&gt; Lines);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public sealed class PlaceOrderHandler</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private readonly IOrderRepository _orders;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public PlaceOrderHandler(IOrderRepository orders) =&gt; _orders = orders;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public async Task&lt;OrderId&gt; Handle(PlaceOrderCommand cmd, CancellationToken ct)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        var order = Order.CreateDraft(cmd.CustomerEmail, cmd.Currency);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        foreach (var l in cmd.Lines)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            order.AddItem(ProductId.From(l.ProductId), l.Quantity, Money.Of(l.UnitPrice, cmd.Currency));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        order.Place();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        await _orders.AddAsync(order, ct);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Optionally publish domain events here</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        foreach (var e in order.DequeueDomainEvents())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // publish e</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        await _orders.SaveChangesAsync(ct);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return order.Id;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="flow-placing-an-order">Flow: placing an order<a href="#flow-placing-an-order" class="hash-link" aria-label="Direct link to Flow: placing an order" title="Direct link to Flow: placing an order">​</a></h3>
<!-- -->
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="cqrs-optional">CQRS (optional)<a href="#cqrs-optional" class="hash-link" aria-label="Direct link to CQRS (optional)" title="Direct link to CQRS (optional)">​</a></h2>
<ul>
<li><strong>Commands</strong> mutate state through aggregates.</li>
<li><strong>Queries</strong> read from optimized read models (e.g., SQL view or denormalized table).</li>
<li>Keep the domain model clean; avoid exposing EF Core internals to the application layer.</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="testing-strategy">Testing strategy<a href="#testing-strategy" class="hash-link" aria-label="Direct link to Testing strategy" title="Direct link to Testing strategy">​</a></h2>
<ul>
<li>Test invariants in the aggregate (unit tests on <code>Order</code>).</li>
<li>Test application services with a fake repository.</li>
<li>Integration-test repositories with a real DB and EF Core.</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="guidelines-and-checklists">Guidelines and checklists<a href="#guidelines-and-checklists" class="hash-link" aria-label="Direct link to Guidelines and checklists" title="Direct link to Guidelines and checklists">​</a></h2>
<ul>
<li>Prefer small, cohesive aggregates. Design for consistency boundaries.</li>
<li>Enforce invariants inside aggregates, not in controllers.</li>
<li>Make value objects immutable and validate on creation.</li>
<li>Use domain events to decouple side-effects like notifications.</li>
<li>Repositories return full aggregates; do not leak ORM entities.</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="references">References<a href="#references" class="hash-link" aria-label="Direct link to References" title="Direct link to References">​</a></h2>
<ul>
<li>Eric Evans, &quot;Domain-Driven Design: Tackling Complexity in the Heart of Software&quot; — <a href="https://www.pearson.com/en-us/subject-catalog/p/domain-driven-design-tackling-complexity-in-the-heart-of-software/P200000003283/9780321125217" target="_blank" rel="noopener noreferrer">Addison-Wesley</a></li>
<li>Vaughn Vernon, &quot;Implementing Domain-Driven Design&quot; — <a href="https://www.pearson.com/en-us/subject-catalog/p/implementing-domain-driven-design/P200000002945/9780321834577" target="_blank" rel="noopener noreferrer">Addison-Wesley</a></li>
<li>Vaughn Vernon, &quot;DDD Reference&quot; — <a href="https://dddcommunity.org/library/vernon_2011/" target="_blank" rel="noopener noreferrer">dddcommunity.org</a></li>
<li>Microsoft Learn, &quot;DDD and Microservices&quot; — <a href="https://learn.microsoft.com/azure/architecture/microservices/model/domain-analysis" target="_blank" rel="noopener noreferrer">learn.microsoft.com</a></li>
</ul>
<hr>
<p>Need more examples? Open an issue with a scenario and we can extend this guide.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="production-grade-architecture">Production-grade architecture<a href="#production-grade-architecture" class="hash-link" aria-label="Direct link to Production-grade architecture" title="Direct link to Production-grade architecture">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="recommended-solution-structure-c">Recommended solution structure (C#)<a href="#recommended-solution-structure-c" class="hash-link" aria-label="Direct link to Recommended solution structure (C#)" title="Direct link to Recommended solution structure (C#)">​</a></h3>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">src/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  OrderService.Api/                # ASP.NET Core minimal APIs or Controllers</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  OrderService.Application/        # Commands, Queries, Handlers, DTOs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  OrderService.Domain/             # Aggregates, ValueObjects, Domain Events, Repositories</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  OrderService.Infrastructure/     # EF Core, Outbox, Repositories, Messaging, DI</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tests/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  OrderService.UnitTests/          # Aggregate and VO tests</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  OrderService.IntegrationTests/   # Repos, outbox, projections</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="layered-architecture-responsibilities">Layered architecture responsibilities<a href="#layered-architecture-responsibilities" class="hash-link" aria-label="Direct link to Layered architecture responsibilities" title="Direct link to Layered architecture responsibilities">​</a></h3>
<ul>
<li><strong>API</strong>: HTTP endpoints, authentication, request validation, mapping to commands/queries.</li>
<li><strong>Application</strong>: Orchestrates use cases; coordinates repositories and domain; no HTTP/EF code.</li>
<li><strong>Domain</strong>: Pure model and invariants; no infrastructure.</li>
<li><strong>Infrastructure</strong>: EF Core, message broker client, outbox, background workers.</li>
</ul>
<!-- -->
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="cqrs-in-depth">CQRS in depth<a href="#cqrs-in-depth" class="hash-link" aria-label="Direct link to CQRS in depth" title="Direct link to CQRS in depth">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="command-model">Command model<a href="#command-model" class="hash-link" aria-label="Direct link to Command model" title="Direct link to Command model">​</a></h3>
<ul>
<li>Commands change state via aggregates; validated at the boundary.</li>
<li>Handlers persist via repositories and emit domain events.</li>
</ul>
<details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary>Command with validation and handler</summary><div><div class="collapsibleContent_i85q"><div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public sealed record AddItemToOrderCommand(Guid OrderId, Guid ProductId, int Quantity, decimal UnitPrice, string Currency);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public sealed class AddItemToOrderHandler</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private readonly IOrderRepository _orders;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public AddItemToOrderHandler(IOrderRepository orders) =&gt; _orders = orders;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public async Task Handle(AddItemToOrderCommand cmd, CancellationToken ct)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (cmd.Quantity &lt;= 0) throw new ArgumentOutOfRangeException(nameof(cmd.Quantity));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        var order = await _orders.GetAsync(OrderId.From(cmd.OrderId), ct)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                     ?? throw new InvalidOperationException(&quot;Order not found&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        order.AddItem(ProductId.From(cmd.ProductId), cmd.Quantity, Money.Of(cmd.UnitPrice, cmd.Currency));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        await _orders.SaveChangesAsync(ct);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div></div></div></details>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="query-model">Query model<a href="#query-model" class="hash-link" aria-label="Direct link to Query model" title="Direct link to Query model">​</a></h3>
<ul>
<li>Queries read from a denormalized read model for performance.</li>
<li>Use Dapper or EF Core to query a read database/schema.</li>
</ul>
<details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary>Query and handler using Dapper</summary><div><div class="collapsibleContent_i85q"><div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public sealed record GetOrderSummary(Guid OrderId);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public sealed class GetOrderSummaryHandler</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private readonly Func&lt;IDbConnection&gt; _readDb;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public GetOrderSummaryHandler(Func&lt;IDbConnection&gt; readDb) =&gt; _readDb = readDb;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public async Task&lt;OrderSummaryDto?&gt; Handle(GetOrderSummary query, CancellationToken ct)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        using var conn = _readDb();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        var sql = @&quot;SELECT Id, CustomerEmail, TotalAmount, Currency, ItemCount</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    FROM OrdersRead WHERE Id = @Id&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return await conn.QuerySingleOrDefaultAsync&lt;OrderSummaryDto&gt;(sql, new { Id = query.OrderId });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public sealed record OrderSummaryDto(Guid Id, string CustomerEmail, decimal TotalAmount, string Currency, int ItemCount);</span><br></span></code></pre></div></div></div></div></details>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="building-the-read-model-projection">Building the read model (projection)<a href="#building-the-read-model-projection" class="hash-link" aria-label="Direct link to Building the read model (projection)" title="Direct link to Building the read model (projection)">​</a></h3>
<!-- -->
<details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary>Projection handler for OrderPlaced</summary><div><div class="collapsibleContent_i85q"><div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public sealed class OrderReadProjection</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private readonly Func&lt;IDbConnection&gt; _readDb;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public OrderReadProjection(Func&lt;IDbConnection&gt; readDb) =&gt; _readDb = readDb;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public async Task Handle(OrderPlaced evt, CancellationToken ct)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        using var conn = _readDb();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        var sql = @&quot;INSERT INTO OrdersRead(Id, CustomerEmail, TotalAmount, Currency, ItemCount)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    VALUES (@Id, @Email, @Amount, @Currency, @Count)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    ON CONFLICT (Id) DO UPDATE SET</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      TotalAmount = EXCLUDED.TotalAmount,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      ItemCount = EXCLUDED.ItemCount&quot;; // PostgreSQL example</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        await conn.ExecuteAsync(sql, new {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Id = evt.OrderId.Value,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Email = &quot;hidden@example.com&quot;, // capture at source</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Amount = evt.Total.Amount,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Currency = evt.Total.Currency,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Count = 0 // compute from event stream if needed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div></div></div></details>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="ddd--cqrs-integration-patterns">DDD + CQRS integration patterns<a href="#ddd--cqrs-integration-patterns" class="hash-link" aria-label="Direct link to DDD + CQRS integration patterns" title="Direct link to DDD + CQRS integration patterns">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="outbox-pattern-transactional-messaging">Outbox pattern (transactional messaging)<a href="#outbox-pattern-transactional-messaging" class="hash-link" aria-label="Direct link to Outbox pattern (transactional messaging)" title="Direct link to Outbox pattern (transactional messaging)">​</a></h3>
<ul>
<li>Persist domain changes and an outbox record in the same transaction.</li>
<li>A background publisher dispatches outbox messages to the broker.</li>
<li>Ensures at-least-once delivery; combine with idempotent consumers.</li>
</ul>
<!-- -->
<details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary>Outbox entity and EF Core integration</summary><div><div class="collapsibleContent_i85q"><div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public sealed class OutboxMessage</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public long Id { get; set; }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public DateTime OccurredOnUtc { get; set; }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public string Type { get; set; } = default!; // e.g., &quot;OrderPlaced&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public string Payload { get; set; } = default!; // JSON</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public DateTime? ProcessedOnUtc { get; set; }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public string? Error { get; set; }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public sealed class OrdersDbContext : DbContext</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public DbSet&lt;OutboxMessage&gt; Outbox =&gt; Set&lt;OutboxMessage&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public override async Task&lt;int&gt; SaveChangesAsync(CancellationToken ct = default)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        var domainEvents = ChangeTracker.Entries()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .Select(e =&gt; e.Entity)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .OfType&lt;Order&gt;()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .SelectMany(o =&gt; o.DequeueDomainEvents())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .ToList();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        foreach (var evt in domainEvents)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Outbox.Add(new OutboxMessage</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                OccurredOnUtc = DateTime.UtcNow,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                Type = evt.GetType().Name,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                Payload = JsonSerializer.Serialize(evt)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return await base.SaveChangesAsync(ct);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div></div></div></details>
<details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary>Background publisher (idempotent)</summary><div><div class="collapsibleContent_i85q"><div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public sealed class OutboxPublisher : BackgroundService</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private readonly IServiceProvider _services;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private readonly IMessageBus _bus; // abstraction over broker client</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public OutboxPublisher(IServiceProvider services, IMessageBus bus)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        _services = services;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        _bus = bus;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected override async Task ExecuteAsync(CancellationToken stoppingToken)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        while (!stoppingToken.IsCancellationRequested)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            using var scope = _services.CreateScope();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            var db = scope.ServiceProvider.GetRequiredService&lt;OrdersDbContext&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            var batch = await db.Outbox</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .Where(x =&gt; x.ProcessedOnUtc == null)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .OrderBy(x =&gt; x.Id)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .Take(100)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .ToListAsync(stoppingToken);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            foreach (var msg in batch)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                try</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    await _bus.PublishAsync(msg.Type, msg.Payload, stoppingToken);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    msg.ProcessedOnUtc = DateTime.UtcNow;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                catch (Exception ex)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    msg.Error = ex.Message;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            await db.SaveChangesAsync(stoppingToken);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            await Task.Delay(TimeSpan.FromSeconds(1), stoppingToken);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div></div></div></details>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="idempotency-for-consumers">Idempotency for consumers<a href="#idempotency-for-consumers" class="hash-link" aria-label="Direct link to Idempotency for consumers" title="Direct link to Idempotency for consumers">​</a></h3>
<ul>
<li>Add a <code>ProcessedMessages</code> table keyed by <code>MessageId</code>.</li>
<li>On consume, insert the <code>MessageId</code> first; if duplicate, skip handling.</li>
</ul>
<details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary>Idempotent consumer skeleton</summary><div><div class="collapsibleContent_i85q"><div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public sealed class OrderPlacedConsumer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private readonly Func&lt;IDbConnection&gt; _readDb;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public async Task Handle(string messageId, OrderPlaced evt, CancellationToken ct)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        using var conn = _readDb();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        using var tx = conn.BeginTransaction();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        var inserted = await conn.ExecuteAsync(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;INSERT INTO ProcessedMessages(MessageId) VALUES (@Id) ON CONFLICT DO NOTHING&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            new { Id = messageId }, tx);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (inserted == 0) return; // already processed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // apply projection changes here</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        await tx.CommitAsync();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div></div></div></details>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="optimistic-concurrency">Optimistic concurrency<a href="#optimistic-concurrency" class="hash-link" aria-label="Direct link to Optimistic concurrency" title="Direct link to Optimistic concurrency">​</a></h3>
<ul>
<li>Use a <code>RowVersion</code> column to detect concurrent updates.</li>
<li>On conflict, reload and retry or return 409 Conflict.</li>
</ul>
<details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary>EF Core concurrency token</summary><div><div class="collapsibleContent_i85q"><div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public sealed class Order</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ... existing members ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public byte[] RowVersion { get; private set; } = Array.Empty&lt;byte&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public sealed class OrdersDbContext : DbContext</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected override void OnModelCreating(ModelBuilder modelBuilder)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        modelBuilder.Entity&lt;Order&gt;(b =&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            b.Property(x =&gt; x.RowVersion).IsRowVersion();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // other mapping</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div></div></div></details>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="sagas-process-managers">Sagas (process managers)<a href="#sagas-process-managers" class="hash-link" aria-label="Direct link to Sagas (process managers)" title="Direct link to Sagas (process managers)">​</a></h3>
<ul>
<li>Coordinate multi-step, long-running workflows across bounded contexts.</li>
<li>Persist saga state; react to events; send commands.</li>
</ul>
<!-- -->
<details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary>Saga state and transitions (simplified)</summary><div><div class="collapsibleContent_i85q"><div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public enum OrderSagaStatus { Started, Paid, Shipped, Completed, Failed }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public sealed class OrderSaga</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Guid Id { get; init; }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public OrderId OrderId { get; init; } = default!;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public OrderSagaStatus Status { get; private set; }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void When(OrderPlaced e) { Status = OrderSagaStatus.Started; }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public IEnumerable&lt;object&gt; When(PaymentSucceeded e) { Status = OrderSagaStatus.Paid; yield return new ArrangeShipment(e.OrderId); }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void When(Shipped e) { Status = OrderSagaStatus.Shipped; }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div></div></div></details>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="security-validation-and-policies">Security, validation, and policies<a href="#security-validation-and-policies" class="hash-link" aria-label="Direct link to Security, validation, and policies" title="Direct link to Security, validation, and policies">​</a></h2>
<ul>
<li>Authentication/Authorization at API boundary (JWT, OAuth2).</li>
<li>Request validation (FluentValidation) before commands.</li>
<li>Resilience policies (Polly) for external calls.</li>
<li>PII handling: avoid leaking sensitive data into events/read models.</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="observability">Observability<a href="#observability" class="hash-link" aria-label="Direct link to Observability" title="Direct link to Observability">​</a></h2>
<ul>
<li>Correlation/causation IDs on commands and events.</li>
<li>Structured logging with scopes per request/command.</li>
<li>Metrics: command latency, handler success/failure, outbox backlog, consumer lag.</li>
<li>Tracing across services (OpenTelemetry).</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="deployment-and-operations">Deployment and operations<a href="#deployment-and-operations" class="hash-link" aria-label="Direct link to Deployment and operations" title="Direct link to Deployment and operations">​</a></h2>
<ul>
<li>Zero-downtime migrations for write and read models.</li>
<li>Blue/green or canary for services publishing new events.</li>
<li>Backpressure: cap publisher batch size and consumer concurrency.</li>
<li>Dead-letter queues and retry policies for message processing.</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="production-checklist">Production checklist<a href="#production-checklist" class="hash-link" aria-label="Direct link to Production checklist" title="Direct link to Production checklist">​</a></h2>
<ul>
<li>Clear bounded contexts and contracts at boundaries.</li>
<li>Aggregates small and cohesive; invariants enforced inside.</li>
<li>Outbox enabled with background publisher.</li>
<li>Consumers idempotent; dedup table in place.</li>
<li>Read model projections cover all critical queries; rebuild procedure documented.</li>
<li>Concurrency conflicts handled with retry or 409.</li>
<li>Comprehensive tests (unit, integration, contract, e2e).</li>
<li>Observability: logs, metrics, traces wired.</li>
</ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/alishahidi/roadmap/tree/main/guides/ddd-csharp.mdx" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Docs pages"></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#what-you-will-learn" class="table-of-contents__link toc-highlight">What you will learn</a></li><li><a href="#core-concepts" class="table-of-contents__link toc-highlight">Core concepts</a></li><li><a href="#big-picture" class="table-of-contents__link toc-highlight">Big picture</a></li><li><a href="#context-mapping" class="table-of-contents__link toc-highlight">Context mapping</a></li><li><a href="#example-domain-orders" class="table-of-contents__link toc-highlight">Example domain: Orders</a><ul><li><a href="#value-objects" class="table-of-contents__link toc-highlight">Value objects</a></li><li><a href="#aggregate" class="table-of-contents__link toc-highlight">Aggregate</a></li><li><a href="#repository-interface" class="table-of-contents__link toc-highlight">Repository interface</a></li><li><a href="#ef-core-mapping-infrastructure" class="table-of-contents__link toc-highlight">EF Core mapping (infrastructure)</a></li><li><a href="#application-service-command-handler" class="table-of-contents__link toc-highlight">Application service (command handler)</a></li><li><a href="#flow-placing-an-order" class="table-of-contents__link toc-highlight">Flow: placing an order</a></li></ul></li><li><a href="#cqrs-optional" class="table-of-contents__link toc-highlight">CQRS (optional)</a></li><li><a href="#testing-strategy" class="table-of-contents__link toc-highlight">Testing strategy</a></li><li><a href="#guidelines-and-checklists" class="table-of-contents__link toc-highlight">Guidelines and checklists</a></li><li><a href="#references" class="table-of-contents__link toc-highlight">References</a></li><li><a href="#production-grade-architecture" class="table-of-contents__link toc-highlight">Production-grade architecture</a><ul><li><a href="#recommended-solution-structure-c" class="table-of-contents__link toc-highlight">Recommended solution structure (C#)</a></li><li><a href="#layered-architecture-responsibilities" class="table-of-contents__link toc-highlight">Layered architecture responsibilities</a></li></ul></li><li><a href="#cqrs-in-depth" class="table-of-contents__link toc-highlight">CQRS in depth</a><ul><li><a href="#command-model" class="table-of-contents__link toc-highlight">Command model</a></li><li><a href="#query-model" class="table-of-contents__link toc-highlight">Query model</a></li><li><a href="#building-the-read-model-projection" class="table-of-contents__link toc-highlight">Building the read model (projection)</a></li></ul></li><li><a href="#ddd--cqrs-integration-patterns" class="table-of-contents__link toc-highlight">DDD + CQRS integration patterns</a><ul><li><a href="#outbox-pattern-transactional-messaging" class="table-of-contents__link toc-highlight">Outbox pattern (transactional messaging)</a></li><li><a href="#idempotency-for-consumers" class="table-of-contents__link toc-highlight">Idempotency for consumers</a></li><li><a href="#optimistic-concurrency" class="table-of-contents__link toc-highlight">Optimistic concurrency</a></li><li><a href="#sagas-process-managers" class="table-of-contents__link toc-highlight">Sagas (process managers)</a></li></ul></li><li><a href="#security-validation-and-policies" class="table-of-contents__link toc-highlight">Security, validation, and policies</a></li><li><a href="#observability" class="table-of-contents__link toc-highlight">Observability</a></li><li><a href="#deployment-and-operations" class="table-of-contents__link toc-highlight">Deployment and operations</a></li><li><a href="#production-checklist" class="table-of-contents__link toc-highlight">Production checklist</a></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Roadmap Sections</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/roadmap/docs/foundations">Foundations</a></li><li class="footer__item"><a class="footer__link-item" href="/roadmap/docs/api-design">API Design</a></li><li class="footer__item"><a class="footer__link-item" href="/roadmap/docs/system-architecture">System Architecture</a></li><li class="footer__item"><a class="footer__link-item" href="/roadmap/docs/data-and-persistence">Data &amp; Persistence</a></li><li class="footer__item"><a class="footer__link-item" href="/roadmap/docs/deployment-and-operations">Deployment &amp; Operations</a></li><li class="footer__item"><a class="footer__link-item" href="/roadmap/docs/observability-and-performance">Observability &amp; Performance</a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Guides</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/roadmap/guides/ddd-csharp">DDD in C#</a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/alishahidi/roadmap" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 The Architect's Roadmap. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>